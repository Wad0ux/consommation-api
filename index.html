<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Popote P2</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 30px;
      background-color: white;
    }
    .container {
      max-width: 900px;
      margin: auto;
      padding: 20px;
      background: royalblue;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    img {
      display: block;
      margin: 0 auto 20px;
      width: 150px;
    }
    select, input, button {
      padding: 8px;
      margin: 5px;
      font-size: 1rem;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: center;
    }
    .actions button {
      margin-right: 10px;
      padding: 10px 15px;
      font-size: 1rem;
      cursor: pointer;
    }
    #consumptionTable {
      display: none;
      margin-top: 20px;
    }
  
    .admin-button {
      padding: 10px 20px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }

    .admin-button:hover {
      background-color: #45a049;
    }
</style>
<body>

  <button class="admin-button" onclick="goToAdmin()">Accéder à la page Admin</button>

  <script>
    function goToAdmin() {
      window.location.href = "admin.html";
    }
  </script>

  <div class="container">

    <h1>Popote P2</h1>

    <div>
      <select id="clientSelect">
        <option value="">-- Sélectionnez un pax --</option>
        <option value="Hanquet">Ltn Hanquet</option>
        <option value="Betin">Adj Bétin</option>
        <option value="Sais">Gnd Sais</option>
      <option value="Walaine">Gnd Walaine</option>
        <option value="Boulogne">Gnd Boulogne</option>
        <option value="Feret">Gnd Féret</option>
          <option value="Boulogne">Gnd Boulogne</option>
          <option value="Taifoury">Gnd Taifoury</option>
        <option value="Perin">Gnd Périn</option>
        <option value="Chaussinand">Gnd Chaussinand</option>
        <option value="Vasseur">Gnd Vasseur</option>
        <option value="Befolo">Gnd Befolo</option>
        <option value="Nageur">Gnd Nageur</option>
        <option value="Gutirez">Gnd Gutirez</option>
        <option value="Hariti">EG Hariti</option>
        <option value="Aujames">EG Aujames</option>
        <option value="Staub">EG Staub</option>
        <option value="Wadoux">EG Wadoux</option>
        </select>

  <label for="productSelect">Produit :</label>
  <select id="productSelect">
    <option value="Canette">Canette</option>
    <option value="Nourriture">Nourriture</option>
    <option value="Redbull">Redbull</option>
  </select>

  <label for="quantity">Quantité :</label>
  <input type="number" id="quantity" min="1" value="1" />

  <button onclick="addConsumption()">Ajouter</button>

  <table id="consumptionTable"></table>

  <script>

function showPopup() {
  document.getElementById("confirmationPopup").style.display = "flex";
}

function closePopup() {
  document.getElementById("confirmationPopup").style.display = "none";
}

//const validPassword = "Bravo117";
// Vérifie si l'utilisateur est authentifié
/*if (!sessionStorage.getItem("isAdmin")) {
  const password = prompt("Mot de passe admin :");
 if (password === validPassword) {
    sessionStorage.setItem("isAdmin", "true");
 } else {
    alert("Accès refusé.");
   window.location.href = "index.html";
  }
}*/

    const apiUrl = "https://consommation-api-1.onrender.com";
    const products = ["Canette", "Nourriture", "Redbull"];
    const productPrices = {
      "Canette": 1,
      "Nourriture": 0.6,
      "Redbull": 1.5
    };

    let data = [];

    window.onload = () => {
      fetch(apiUrl + "/all")
        .then(res => res.json())
        .then(json => {
          data = json;
          renderTable();
        });
    };

    function addConsumption() {
      const client = document.getElementById("clientSelect").value;
      const product = document.getElementById("productSelect").value;
      const quantity = parseInt(document.getElementById("quantity").value);

      if (!client || !product || isNaN(quantity) || quantity <= 0) {
        alert("Sélection non valide camarade !");
        return;
      }

      fetch(apiUrl + "/add", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ client, product, quantity })
      }).then(() => {
        fetch(apiUrl + "/all")
          .then(res => res.json())
          .then(json => {
            data = json;
            renderTable();
          });
       showPopup(); document.getElementById("quantity").value = "";
      });
    }

    function renderTable() {
      const table = document.getElementById("consumptionTable");
      const clients = [...new Set(data.map(e => e.client))].sort();

      let html = "<thead><tr><th>Client</th>";
      products.forEach(p => html += `<th>${p}</th>`);
      html += "<th>Prix total (€)</th></tr></thead><tbody>";

      clients.forEach(client => {
        html += `<tr><td>${client}</td>`;
        let totalPrice = 0;
        products.forEach(product => {
          const entry = data.find(e => e.client === client && e.product === product);
          const qty = entry ? entry.quantity : 0;
          html += `<td>${qty}</td>`;
          totalPrice += qty * (productPrices[product] || 0);
        });
        html += `<td>${totalPrice.toFixed(2)}</td></tr>`;
      });

      html += "</tbody>";
      table.innerHTML = html;
    }

    function exportCSV() {
      if (data.length === 0) {
        alert("Aucune donnée à exporter.");
        return;
      }
      const clients = [...new Set(data.map(e => e.client))].sort();
      let csv = "Pax," + products.join(",") + ",Prix total (€)\n";

      clients.forEach(client => {
        const row = [client];
        let totalPrice = 0;
        products.forEach(product => {
          const entry = data.find(e => e.client === client && e.product === product);
          const qty = entry ? entry.quantity : 0;
          row.push(qty);
          totalPrice += qty * (productPrices[product] || 0);
        });
        row.push(totalPrice.toFixed(2));
        csv += row.join(",") + "\n";
      });

      const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const link = document.createElement("a");
      link.setAttribute("href", url);
      link.setAttribute("download", "consommation_clients.csv");
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    function toggleTable() {
      const table = document.getElementById("consumptionTable");
      const btn = document.getElementById("toggleBtn");
      const visible = table.style.display === "table";

      table.style.display = visible ? "none" : "table";
      btn.textContent = visible ? "Afficher les données" : "Masquer les données";
    }

 /*function promptAdmin() {
    const password = prompt("Mot de passe requis pour accéder à la page admin :");
    const adminPassword = "Bravo117";

    if (password === adminPassword) {
      window.location.href = "admin.html";
    } else {
      alert("⛔ Mot de passe incorrect.");
    }
  }*/

  </script>
<!-- Popup de confirmation -->
<div id="confirmationPopup" style="
  display: none;
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(0, 0, 0, 0.6);
  justify-content: center;
  align-items: center;
  z-index: 1000;
">
  <div style="
    background: white;
    padding: 30px;
    border-radius: 10px;
    text-align: center;
    max-width: 300px;
    box-shadow: 0 0 10px rgba(0,0,0,0.3);
  ">
    <p>✅ Ajout enregistré avec succès !</p>
    <button onclick="closePopup()" style="
      padding: 8px 16px;
      margin-top: 10px;
      font-size: 16px;
    ">OK</button>
  </div>
</div>
</body>
</html>